#!/usr/bin/env zsh

is_git_repo() {
    local dir="$1"
    [[ $(git -C "$dir" rev-parse --is-inside-work-tree 2>/dev/null) == "true" ]]
}

if [[ $# -eq 0 ]]; then
    selected_path=$PWD
elif [[ -e "$1" ]]; then
    selected_path=$(realpath $1)
else
    echo "Argument contained an invalid path">&2
    exit 0
fi

if is_git_repo selected_path; then
    working_directory=$(git rev-parse --show-toplevel)
elif [[ -d "$1" ]]; then
    working_directory=$selected_path
else
    working_directory=$(dirname $selected_path)
fi

selected_path_hash=$(sha256 <<< "$selected_path")
session="$(basename $selected_path  | tr . _)-${selected_path_hash:0:4}"

if ! tmux has-session -t=$session 2> /dev/null; then
    tmux new-session -ds $session -c $working_directory hx "$selected_path"

    # Start lazygit if in git repo
    if is_git_repo $selected_path; then
        tmux new-window -c $working_directory lazygit
    fi

fi

if [[ -z $TMUX ]]; then
    tmux attach -t $session:1
else
    tmux switch-client -t $session:1
fi

